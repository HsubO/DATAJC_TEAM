<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>for 조 in range(3):어린이집 국공립 쏠림 현상</title>
  
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* 폰트 설정 */
    @font-face {
      font-family: 'YesMyungjo';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_13@1.0/YESMyoungjo-Regular.woff') format('woff');
      font-weight: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'YesMyungjo';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_13@1.0/YESMyoungjo-Bold.woff') format('woff');
      font-weight: 700;
      font-display: swap;
    }

    /* --- 1. 기본 스타일 --- */
    :root {
      --bgL: 0%; --fg: #ffffff; --muted: #9ca3af;
      --border: #cbd5e1; --ok: #22c55e; --bad: #ef4444;
      --text-black:#111827; --text-gray:#9ca3af; --text-green:#16a34a;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      overflow: hidden;
      background: hsl(0 0% var(--bgL));
      color: var(--fg);
      font-family: 'YesMyungjo', 'Apple SD Gothic Neo', sans-serif;
      transition: background-color 400ms ease, color 400ms ease;
    }
    .light { --fg: #111827; --muted: #6b7280; }
    .light .hud kbd { background: rgba(0,0,0,.06); border-color: rgba(0,0,0,.12); }

    /* --- 섹션 공통 스타일 --- */
    .fullscreen-section {
      display: flex; position: fixed; inset: 0;
      align-items: center; justify-content: center;
      opacity: 0; pointer-events: none;
      transition: opacity 600ms ease;
      padding: 24px;
      flex-direction: column; /* 자식 요소 세로 정렬을 위해 추가 */
    }

    /* --- 2. 문장 스크롤 파트 --- */
    .stage {
      display: grid; position: fixed; inset: 0;
      place-items: center; padding: 24px;
      transition: opacity 600ms ease;
    }
    .line {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      max-width: 860px; width: min(90vw, 860px);
      text-align: center; line-height: 1.6;
      font-size: clamp(18px, 4.8vw, 34px);
      opacity: 0; filter: blur(4px); transform-origin: center;
      transition: opacity 420ms ease, filter 420ms ease, transform 420ms ease;
      will-change: opacity, filter, transform;
      word-break: keep-all; line-break: strict; text-wrap: balance; hyphens: none;
    }
    .line.visible { opacity: 1; filter: blur(0); }
    .line.out { opacity: 0; filter: blur(6px); transform: translate(-50%, -50%) scale(.985); }
    .hud {
      position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
      font-size: 13px; color: var(--muted); user-select: none;
      transition: opacity 600ms ease;
    }
    .hud kbd { background: rgba(255,255,255,.1); padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,.2); }
    mark.pink { background: linear-gradient(transparent 58%, rgba(255, 99, 170, .65) 58%); color: inherit; padding: 0 .15em; border-radius: 2px; -webkit-box-decoration-break: clone; box-decoration-break: clone; }
    .nb { white-space: nowrap; }
    mark.yellow {
      background-color: #fef08a;
      color: inherit; padding: 0 .15em; border-radius: 2px;
      -webkit-box-decoration-break: clone; box-decoration-break: clone;
    }

    /* --- 3. 퀴즈 파트 --- */
    #quiz-container h1 { margin: 0 0 clamp(56px, 22vh, 320px) 0; text-align: center; font-size: clamp(28px, 4vw, 44px); font-weight: 700; }
    .quiz { display: flex; gap: 48px; align-items: center; justify-content: center; }
    .card {
      width: clamp(320px, 28vw, 440px); height: clamp(200px, 20vw, 280px); border-radius: 28px;
      background: #f9fafb; border: 6px solid var(--border); display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: transform .35s ease, border-color .3s ease, box-shadow .3s ease;
      font-size: clamp(28px, 3vw, 42px); font-weight: 700; user-select: none;
      animation: fadeInUp .6s ease both; position: relative; color: #111827;
    }
    .card:hover { transform: translateY(-8px) scale(1.04); }
    .card.correct { border-color: var(--ok); }
    .card.wrong { border-color: var(--bad); }
    .overlay {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
      background: rgba(255, 255, 255, .72); backdrop-filter: blur(2px); font-weight: 700;
      font-size: clamp(16px, 1.8vw, 24px); border-radius: inherit; pointer-events: none;
      opacity: 0; animation: overlayIn .35s ease forwards;
    }
    @keyframes overlayIn { to { opacity: 1 } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px) scale(.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

    /* --- 4. 기사문 & 큰 문장 파트 --- */
    .article { color: #111827; }
    .article p {
      max-width: 860px; width: min(90vw, 860px);
      font-size: clamp(19px, 2.8vw, 28px);
      line-height: 1.7; text-align: justify;
    }
    
    /* --- 5. 수식 스크롤 인터랙션 파트 --- */
    #equation-section h1 {
      color: var(--text-black);
      font-size: clamp(28px, 4vw, 44px);
      font-weight: 700;
      text-align: center;
      margin: 0 0 clamp(56px, 22vh, 320px) 0;
      font-family: 'YesMyungjo', sans-serif;
    }
    .equation-wrap{width:80vw;max-width:80vw;display:flex;justify-content:center}
    .fitbox{transform:scale(var(--fit,1));transform-origin:center center;}
    .equation{display:flex;align-items:center;justify-content:center;gap:2.5rem;white-space:nowrap;line-height:1.1;flex-wrap:nowrap;position:relative;}
    .chunk{display:inline-block;font-weight:900;font-size:clamp(4rem, 7vw + 1rem, 10rem);}
    .lhs,.rhs{transition: color 420ms ease, transform 520ms cubic-bezier(0.22,0.61,0.36,1)}
    .op-static{font-weight:900;font-size:clamp(4rem, 6vw + 1rem, 10rem);transition:opacity 300ms ease;margin:0 1rem;}
    .op-floating{font-weight:900;font-size:clamp(4rem, 7vw + 1rem, 10rem);opacity:0;transition:opacity 300ms ease;margin-right:6rem;}

    /* --- 6. 이미지 갤러리 파트 --- */
    .image-container {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      justify-content: center;
      align-items: center;
      width: 100%;
      max-width: 1400px;
    }
    .image-container img {
      max-width: 48%;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      flex-grow: 1;
      min-width: 300px;
    }
    
    /* --- 7. 아이사랑/인프라 지도 파트 --- */
    #infra-map {
        --speed: 820ms;
        --ease: cubic-bezier(.22,.95,.17,.99);
        --panel-w: min(1100px, 92vw);
        --panel-h: clamp(560px, 70vh, 780px);
        font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Apple SD Gothic Neo,Helvetica,Arial;
        color: #0f172a;
    }
    .infra-title{position:relative; text-align:center; font-weight:900; font-size:clamp(18px,2vw,24px); margin-bottom:18px}
    .panel{position:relative; width:var(--panel-w); height:var(--panel-h); margin:0 auto; border:2px solid rgba(15,23,42,.16); border-radius:24px; background:#fff; box-shadow:0 20px 48px rgba(2,6,23,.06), inset 0 0 0 8px rgba(241,245,249,.5)}
    .canvas{position:absolute; inset:18px; border-radius:16px; overflow:hidden;}
    .canvas svg{position:absolute; inset:0; z-index:0; pointer-events:none}
    .node{position:absolute; transform:translate(-50%,-50%); padding:.55em .9em; border-radius:999px; border:2px solid rgba(15,23,42,.14); background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.06); font-weight:700; white-space:nowrap; z-index:1; transition: all var(--speed) var(--ease);}
    .node.core{border-radius:28px; padding:1.0em 1.4em; font-weight:900; font-size:clamp(18px,2.2vw,26px); border-color:#111; color:#111}
    .node.cat{border-radius:16px; color:#111}
    .node.detail{border-radius:12px; font-weight:700; font-size:14px}
    .hint{position:absolute; bottom:10px; left:50%; transform:translateX(-50%); font-size:12px; color:#94a3b8}

    /* --- 8. 차트/지도 스타일 --- */
    .chart-map-header { padding:20px 16px 8px; text-align:center; color: #111827; }
    .chart-map-header h1 { margin:0 0 6px; font-size:clamp(22px,3.2vw,28px); }
    .chart-map-header h2 { text-align: center; color: #6b7280; font-weight: 500;}
    #status { text-align:center; color:#6b7280; margin-bottom:10px; }
    .view-container { 
        width: 95%; 
        max-width: 1200px; 
        height: 75vh;
        margin: auto; 
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        padding: 1rem;
        box-sizing: border-box;
    }
    #map {
        width: 100%;
        height: 100%;
        border-radius: 8px;
    }
    #search-container { text-align: center; margin-bottom: 20px; }
    #searchInput { padding: 8px 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; min-width: 300px; }
    #searchButton { padding: 8px 16px; font-size: 16px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; }
    #searchButton:hover { background-color: #2563eb; }
    
    /* --- 9. 감사 인사 스타일 --- */
    #thank-you-section {
        color: #111827;
        font-family: 'YesMyungjo', sans-serif;
    }
    .thank-you-title {
        font-size: clamp(48px, 10vw, 96px);
        font-weight: 700;
        margin: 0;
    }
    .credits {
        position: absolute;
        bottom: 40px;
        right: 40px;
        text-align: right;
        font-size: 14px;
        color: #6b7280;
        line-height: 1.6;
    }

    @media (max-width: 768px) {
      .image-container img { max-width: 90%; }
      #image-gallery-section { justify-content: flex-start; padding-top: 50px; gap: 30px; }
      .credits { font-size: 12px; bottom: 20px; right: 20px; }
    }
    @media (max-width: 980px) { .quiz { flex-direction: column } }
  </style>
</head>
<body>
  <div class="stage"></div>
  <div class="hud">마우스 휠로 이동 · <kbd>↓</kbd>/<kbd>Space</kbd> 다음 · <kbd>↑</kbd> 이전</div>

  <main id="quiz-container" class="fullscreen-section">
    <h1>국공립 어린이집의<br>실제 경쟁률은 얼마일까요?</h1>
    <section class="quiz" id="quiz">
      <button class="card" data-correct="false" data-label="아파트 청약 (서울)">1 : 88.2</button>
      <button class="card" data-correct="true" id="answerCard" data-label="국공립 어린이집 (서울)">1 : 1613</button>
      <button class="card" data-correct="false" data-label="7급 공무원 (행정직)">1 : 76.9</button>
    </section>
  </main>

  <section id="article-intro" class="fullscreen-section article">
    <p>&nbsp;‘1 : 1613’. 서울 아파트 청약 경쟁률(1 : 88.2), 서울 지방직 7급 공무원 경쟁률(1 : 98.1)을 뛰어넘는 경쟁률은 서울 ‘국공립 어린이집(오금숲어린이집)’의 0세 입소대기 경쟁률이다. 해당 경쟁률은 민간 어린이집 상위와 비교해 두드러지는 수치이며, 대기율 상위 25개 어린이집은 모두 국공립 어린이집에 해당한다.</p>
  </section>

  <section id="equation-section" class="fullscreen-section">
    <h1>학부모들은 어떤 걸 원할까?</h1>
    <div class="equation-wrap">
      <div class="fitbox" id="fit">
        <div class="equation" id="eq">
          <div class="chunk lhs" id="lhs">출산 휴가</div>
          <div class="op-static" id="opOr">or</div>
          <div class="op-floating" id="opLt">&lt;</div>
          <div class="chunk rhs" id="rhs">국공립 시설 확충</div>
        </div>
      </div>
    </div>
  </section>

  <section id="article-outro" class="fullscreen-section article">
    <p>국공립 어린이집은 국가 관리(국립) 어린이집과 지자체 관리(지자체) 어린이집을 통칭하는 표현이다. 민간어린이집 최소 정원(21명)보다 적은 규모로(11명) 운영 가능하며, 운영 규정 충족에 따라 재정을 지원받는 등 이상적인 보육 기관의 표준으로 제도화됐다. 영유아(0-5세) 학부모도 가장 원하는 보육정책으로 ‘육아 휴직제도 정착’보다 ‘국공립어린이집 확충’을 지목했고(전국보육실태조사, 2021), 2023년 3월, 교육부(이주호 장관)는 국공립 어린이집을 연마다 500개소씩 증원한다는 정책을 발표하기도 했다.</p>
  </section>
  
  <section id="article-stats" class="fullscreen-section article">
    <p>35년에 걸쳐 정권을 막론하고 국공립어린이집에 대한 수요가 많은 가운데, 해당 정책 기조를 가장 잘 실현하고 있는 지자체는 <mark class="pink nb">서울광역시다</mark>. 2025년 8월 21일 기준, 서울시가 관리하는 국공립어린이집은 1863개소로 전국(4,958개소) 국공립 어린이집의 <mark class="yellow nb">약 37.6%</mark>이자 서울시 전체 어린이집(4020개소)의 <mark class="yellow nb">약 46.3%</mark>에 해당한다.</p>
  </section>

  <section id="image-gallery-section" class="fullscreen-section">
    <div class="image-container">
      <img src="./up.png" alt="자치구별 상위 25% 어린이집 수 비교">
      <img src="./down.png" alt="자치구별 하위 25% 어린이집 수 비교">
    </div>
  </section>

  <section id="article-final" class="fullscreen-section article">
    <p>이러한 학부모 사이의 소문은 누군가의 어린이집 입소대기 현황을 통해서도 나타난다. 서울 자치구별 어린이집 입소대기율 상위 25% 어린이집의 설립유형을 분류했을 때, 대기율 하위 25%에 비해 국공립 비중이 가시적으로 차이나는 것으로 확인된다. 서울시 내 국공립 어린이집 1,863곳 가운데 대기 인원이 없는 곳은 9곳에 불과하다.
</p>
  </section>

  <section id="infra-map" class="fullscreen-section">
    <div class="infra-title" id="infra-map-title">아이사랑 포털 → 지표 수집</div>
    <div class="panel">
      <div class="canvas" id="infra-map-canvas">
        <svg id="infra-map-links"></svg>
        <div class="hint">휠 ↓ : 인프라로 전환 · 휠 ↑ : 다시 아이사랑</div>
      </div>
    </div>
  </section>
  
  <section id="article-source" class="fullscreen-section article">
    <p>앞서 언급한 ‘아이사랑’(임신육아종합포털)은 요약 정보 외 9개 항목(기본 현황, 아동ㆍ교사 현황, 교육ㆍ보육 과정, 회계, 영양ㆍ위생, 안전관리, 위반내역, 평가, 연장보육반)을 통해 어린이집을 확인할 수 있는 정보를 제공하고 있다. 본 기획은 해당 항목 중 CCTV, 연장반 운영, 교사 및 조리사 현황 등 요약 정보를 바탕으로 ‘학부모’의 시선에서 어린이집을 평가하는 것으로 시작한다.</p>
  </section>

  <section id="scatter-plot-section" class="fullscreen-section">
    <header class="chart-map-header">
      <h1>공급 vs 수요 (국공립/민간)</h1>
      <div id="status">CSV 파일을 불러오는 중...</div>
    </header>
    <div id="search-container">
      <input type="text" id="searchInput" placeholder="기관명 검색 (예: 삼성)">
      <button id="searchButton">검색</button>
    </div>
    <div class="view-container">
      <canvas id="scatterChart"></canvas>
    </div>
  </section>

  <section id="map-view-section" class="fullscreen-section">
      <header class="chart-map-header">
          <h2>어린이집 분포 지도</h2>
      </header>
      <div class="view-container">
        <div id="map"></div>
      </div>
  </section>

  <section id="article-conclusion" class="fullscreen-section article">
    <p>국공립 여부나 일부 수치만으로는 보육 현장을 온전히 평가하기에 한계가 있으며, 공개된 정보와 실제 현장 수준 사이의 괴리가 크다는 뜻이다. 따라서 이제 정부와 지자체는 양적 증설 중심의 보육 정책에서 벗어나, 학부모가 실질적으로 참고할 수 있는 정성적·정량적 정보를 데이터 기반으로 재정비하고 정보 공개 및 평가 기준의 신뢰성을 강화해야 한다. 제도가 아무리 바뀌고 소멸되어도 그 위에 남는 것은 결국 아이와 부모 등 사람이라는 사실을 잊지 말아야 할 것이다.</p>
  </section>

  <section id="thank-you-section" class="fullscreen-section">
    <h1 class="thank-you-title">감사합니다</h1>
    <div class="credits">
      SBS 데이터 사이언스와 저널리즘 아카데미 3기<br>
      최은재 김세현 김호섭 유혜빈 이혜연
    </div>
  </section>
  <script>
    /* --- 통합 스크립트 --- */
    // --- 1. 상태 및 요소 정의 ---
    const LINES = ["아이의 이름을 새겼다.","아이가 세상에 나온 시각과 장소를 남겼다.", "대기표를 부여쥔 채 접수창구를 향해 빠른 걸음을 내딛었다.", "출생신고서를 건네며 생명이 탄생했음을 세상에 고했다.", "아이의 이름 위로 출생을 축하하듯 확인 도장이 경쾌하게 찍힌다.", "아이는 국공립 어린이집 입소대기 명부의 827번째 대기자가 되는 영광을 안았다."];
    const HIGHLIGHT_TARGET = /827번째\s*대기자/;
    
    const QUIZ_IDX = LINES.length;
    const ARTICLE_INTRO_IDX = LINES.length + 1;
    const EQUATION_IDX = LINES.length + 2;
    const ARTICLE_OUTRO_IDX = LINES.length + 3;
    const ARTICLE_STATS_IDX = LINES.length + 4;
    const IMAGE_GALLERY_IDX = LINES.length + 5;
    const ARTICLE_FINAL_IDX = LINES.length + 6;
    const INFRA_MAP_IDX = LINES.length + 7;
    const ARTICLE_SOURCE_IDX = LINES.length + 8;
    const SCATTER_PLOT_IDX = LINES.length + 9;
    const MAP_VIEW_IDX = LINES.length + 10;
    const ARTICLE_CONCLUSION_IDX = LINES.length + 11; // 신규: 마지막 기사문
    const THANK_YOU_IDX = LINES.length + 12;          // 신규: 감사 인사
    let idx = -1;
    let busy = false;
    let equationSubState = 0;
    let infraMapSubState = 0;

    // DOM 요소
    const stage = document.querySelector('.stage'), hud = document.querySelector('.hud');
    const quizContainer = document.getElementById('quiz-container'), articleIntro = document.getElementById('article-intro');
    const equationSection = document.getElementById('equation-section'), articleOutro = document.getElementById('article-outro');
    const articleStats = document.getElementById('article-stats'), imageGallerySection = document.getElementById('image-gallery-section');
    const articleFinal = document.getElementById('article-final');
    const infraMapSection = document.getElementById('infra-map');
    const articleSource = document.getElementById('article-source');
    const scatterPlotSection = document.getElementById('scatter-plot-section');
    const mapViewSection = document.getElementById('map-view-section');
    const articleConclusionSection = document.getElementById('article-conclusion'); // 신규 DOM
    const thankYouSection = document.getElementById('thank-you-section');       // 신규 DOM
    
    const eqFitbox = document.getElementById('fit'), eq = document.getElementById('eq'), eqLhs = document.getElementById('lhs'), eqRhs = document.getElementById('rhs'), eqOpOr = document.getElementById('opOr'), eqOpLt = document.getElementById('opLt');

    const lineNodes = LINES.map((text, i) => {
        const div = document.createElement('div');
        div.className = 'line';
        if (i === LINES.length - 1) {
            const html = text.replace(HIGHLIGHT_TARGET, m => `<mark class="pink nb">${m.replace(/\s+/g,'&nbsp;')}</mark>`);
            div.innerHTML = html;
        } else {
            div.textContent = text;
        }
        stage.appendChild(div);
        return div;
    });

    // --- 2. 기능 함수 (기존) ---
    function setThemeByIndex(i) {
      const last = LINES.length - 1; let l;
      const themeIdx = Math.min(i, last); 
      if (i >= SCATTER_PLOT_IDX) { // 차트/지도부터 끝까지 밝은 테마 유지
          document.body.classList.add('light'); 
          document.body.style.setProperty('--bgL', '100%'); 
          return; 
      }
      if (themeIdx >= last) { l = 100; } else { const t = (last > 1) ? (themeIdx / (last - 1)) : 0; l = Math.round(0 + 30 * t); }
      document.body.style.setProperty('--bgL', l + '%'); document.body.classList.toggle('light', themeIdx >= last);
    }

    function setEquationState(s) {
      if (s === 0) {
        eqOpOr.style.display = 'inline-block'; eqOpOr.style.opacity = '1'; eqOpLt.style.display = 'none'; eqOpLt.style.opacity = '0';
        eqLhs.style.color = 'var(--text-black)'; eqRhs.style.color = 'var(--text-black)'; eqLhs.style.transform = 'scale(1)'; eqRhs.style.transform = 'scale(1)';
      } else {
        eqOpOr.style.display = 'none'; eqOpOr.style.opacity = '0'; eqOpLt.style.display = 'inline-block'; eqOpLt.style.opacity = '1';
        eqLhs.style.color = 'var(--text-gray)'; eqRhs.style.color = 'var(--text-green)'; eqLhs.style.transform = 'scale(0.9)'; eqRhs.style.transform = 'scale(1.15)';
      }
      equationSubState = s;
    }

    const autoFitEquation = () => { eqFitbox.style.setProperty('--fit', 1); const scale = Math.min(1, eqFitbox.parentElement.clientWidth / eq.scrollWidth); eqFitbox.style.setProperty('--fit', scale || 1); };

    function renderState(targetIdx) {
      if (busy) return; if (targetIdx < 0 || targetIdx > THANK_YOU_IDX) return; // 범위 수정
      busy = true;

      const sections = [quizContainer, articleIntro, equationSection, articleOutro, articleStats, imageGallerySection, articleFinal, infraMapSection, articleSource, scatterPlotSection, mapViewSection, articleConclusionSection, thankYouSection]; // 배열에 신규 섹션 추가
      sections.forEach(s => { if(s) { s.style.opacity = '0'; s.style.pointerEvents = 'none'; } });
      if (idx >= 0 && idx < QUIZ_IDX) { lineNodes[idx].classList.remove('visible'); lineNodes[idx].classList.add('out'); }

      setThemeByIndex(targetIdx);

      if (targetIdx < QUIZ_IDX) {
        stage.style.opacity = '1'; hud.style.opacity = '1';
        lineNodes[targetIdx].classList.remove('out'); lineNodes[targetIdx].classList.add('visible');
      } else {
        stage.style.opacity = '0'; 
        // 마지막 감사 화면에서는 HUD 숨김
        hud.style.opacity = (targetIdx === THANK_YOU_IDX) ? '0' : '1';
        const targetSection = sections[targetIdx - QUIZ_IDX];
        if (targetSection) { targetSection.style.opacity = '1'; targetSection.style.pointerEvents = 'auto'; }
      }
      
      if (targetIdx === MAP_VIEW_IDX && !isMapPopulated) {
        populateMap(document.getElementById('searchInput').value.trim().toLowerCase());
      } else if (idx === MAP_VIEW_IDX && targetIdx !== MAP_VIEW_IDX) {
        clearMap();
      }

      idx = targetIdx;
      setTimeout(() => { busy = false; }, 600);
    }

    function next() { if (idx < THANK_YOU_IDX) renderState(idx + 1); } // 범위 수정
    function prev() { if (idx > 0) renderState(idx - 1); }

    // --- 3. 이벤트 리스너 (기존) ---
    function handleScroll(e) {
      if (busy) return;
      if (idx === EQUATION_IDX) {
        if (e.deltaY > 8) { if (equationSubState === 0) setEquationState(1); else next(); } 
        else if (e.deltaY < -8) { if (equationSubState === 1) setEquationState(0); else prev(); }
      } else if (idx === INFRA_MAP_IDX) {
        if (e.deltaY > 8) { if (infraMapSubState === 0) { infraMapLogic.toInfra(); infraMapSubState = 1; } else next(); } 
        else if (e.deltaY < -8) { if (infraMapSubState === 1) { infraMapLogic.toInitial(); infraMapSubState = 0; } else prev(); }
      }
      else {
        if (e.deltaY > 8) next(); else if (e.deltaY < -8) prev();
      }
    }
    window.addEventListener('wheel', handleScroll, { passive: true });

    (function () { // 퀴즈 로직
      const cards = Array.from(document.querySelectorAll('.card'));
      const answer = document.getElementById('answerCard'); let locked = false;
      cards.forEach(card => {
        card.addEventListener('click', () => {
          if (locked) return; locked = true;
          cards.forEach(c => c.classList.remove('correct', 'wrong'));
          if (card.dataset.correct === 'true') { card.classList.add('correct'); } else { card.classList.add('wrong'); answer.classList.add('correct'); }
          cards.filter(c => c.dataset.correct !== 'true').forEach(c => {
            if (c.querySelector('.overlay')) return; const ov = document.createElement('div');
            ov.className = 'overlay'; ov.textContent = c.dataset.label || '오답'; c.appendChild(ov);
          });
        });
      });
    })();
    
    // --- 4. 인프라 맵 로직 (수정 없음) ---
    const infraMapLogic = (function(){
        let drawTimeoutId = null;
        const title = document.getElementById('infra-map-title');
        const canvas = document.getElementById('infra-map-canvas');
        const svg = d3.select('#infra-map-links');
        const W = ()=>canvas.clientWidth; const H = ()=>canvas.clientHeight;
        const rainbow = ['#e11d48','#f97316','#eab308','#22c55e','#0ea5e9','#8b5cf6','#a855f7'];
        const seven = ['교사','특별활동','CCTV','연장보육반','예산','급식','보험'];
        const colorMap = {}; seven.forEach((s,i)=>{colorMap[s]=rainbow[i%rainbow.length];});
        const cats = ['인력','규모','안전','서비스','비용'];
        const detailMap = { '교사': ['총교직원','1급교사비율','근속4년이상'], '특별활동': ['특별활동점수'], '보험': ['보험가입수'], '연장보육반': ['연장차량','연장반수','연장반겸직'], '급식': ['조리사수'], 'CCTV': ['CCTV점수'], '예산': ['기타경비'], '서비스': ['통학차량'], '규모': ['보육실놀이실총면적'] };
        const mapToCat = { '교사':'인력','특별활동':'서비스','CCTV':'안전','연장보육반':'규모','예산':'비용','급식':'인력','보험':'안전','서비스':'서비스','규모':'규모' };
        const details = []; const detailColor={};
        Object.entries(detailMap).forEach(([k,v])=> v.forEach(d=>{ details.push({id:d,cat:mapToCat[k]}); detailColor[d]=(colorMap[k]||'#111'); }));
        const g = d3.select('#infra-map-canvas');
        function node(id, cls, col){ return g.append('div').attr('class','node '+cls).attr('data-id',id).text(id).style('color',col||'#111'); }
        const core = node('아이사랑','core','#111');
        const nodes7 = seven.map(s=>node(s,'pill',colorMap[s]));
        const nodes5 = cats.map(s=>node(s,'cat','#111').style('opacity',0));
        const nodesD = details.map(d=>node(d.id,'detail',detailColor[d.id]||'#111').style('opacity',0));
        function rect(el){ return el.node().getBoundingClientRect(); }
        function local(pt){ const r = canvas.getBoundingClientRect(); return {x:pt.x-r.left,y:pt.y-r.top}; }
        function anchorRight(el){ const r = rect(el); return {x:r.right,y:r.top+r.height/2}; }
        function anchorLeft(el){ const r = rect(el); return {x:r.left,y:r.top+r.height/2}; }
        function curve(a,b){ const dx=(b.x-a.x)*0.6; const dy=(b.y-a.y)*0.08; return `M ${a.x},${a.y} C ${a.x+dx},${a.y+dy} ${b.x-dx},${b.y-dy} ${b.x},${b.y}`; }
        function syncSVG(){ svg.attr('width', W()).attr('height', H()).attr('viewBox', `0 0 ${Math.round(W())} ${Math.round(H())}`); }
        function layoutInitial(){
            const cx=W()*0.18, cy=H()*0.5;
            core.text('아이사랑').style('left',cx+'px').style('top',cy+'px');
            const rightX=W()*0.58, top=H()*0.12, bottom=H()*0.88, step=(bottom-top)/(seven.length-1);
            nodes7.forEach((n,i)=>n.style('left',rightX+'px').style('top',(top+i*step)+'px').style('opacity',1).style('filter','none'));
            nodes5.forEach(n=>n.style('opacity',0)); nodesD.forEach(n=>n.style('opacity',0));
            title.textContent='아이사랑 포털 → 지표 수집';
        }
        function drawLinksInitial(){
            syncSVG(); svg.selectAll('path').remove();
            const cA=local(anchorRight(core));
            nodes7.forEach(n=>{ const tA=local(anchorLeft(n)); svg.append('path').attr('d',curve(cA,tA)).attr('stroke','#111').attr('fill','none').attr('stroke-width',3).attr('stroke-linecap','round').attr('opacity',0.98); });
        }
        function layoutInfra(){
            const coreX=W()*0.18, coreY=H()*0.5;
            core.text('인프라').style('left',coreX+'px').style('top',coreY+'px');
            const midX=W()*0.42;
            const top=H()*0.2, step5=(H()*0.6)/(cats.length-1);
            nodes7.forEach(n=>n.style('opacity',0));
            nodes5.forEach((n,i)=>n.style('left',midX+'px').style('top',(top+i*step5)+'px').style('opacity',1));
            const rightBase = midX + 160; const horizontalMargin = 16;
            cats.forEach((catString, catIdx) => {
                const baseY = top + catIdx * step5;
                const detailNodesForCat = nodesD.filter(n => { const id = n.attr('data-id'); const detailInfo = details.find(d => d.id === id); return detailInfo && detailInfo.cat === catString; });
                let currentX = 0, previousNodeWidth = 0;
                detailNodesForCat.forEach((n, detailIdx) => {
                    const currentNodeWidth = n.node().getBoundingClientRect().width;
                    if (detailIdx === 0) { currentX = rightBase; } else { currentX += (previousNodeWidth / 2) + horizontalMargin + (currentNodeWidth / 2); }
                    n.style('left', currentX + 'px').style('top', baseY + 'px').style('opacity', 1);
                    previousNodeWidth = currentNodeWidth;
                });
            });
            title.textContent='인프라 점수 (세부 지표 연결)';
        }
        function drawLinksCatsToDetails(){
            syncSVG(); svg.selectAll('path').remove();
            const cA=local(anchorRight(core));
            nodes5.forEach(n=>{ const tA=local(anchorLeft(n)); svg.append('path').attr('d',curve(cA,tA)).attr('stroke','#111').attr('stroke-width',3).attr('stroke-linecap','round').attr('fill','none').attr('opacity',0.98); });
            nodes5.forEach(n=>{
                const cat=n.attr('data-id'); const t=local(anchorRight(n));
                const firstDetail = details.find(d=>d.cat===cat); if(!firstDetail) return;
                const dn = d3.select(`.node.detail[data-id='${firstDetail.id}']`); if (dn.empty()) return;
                const dpt = local(anchorLeft(dn));
                svg.append('path').attr('d',curve(t,dpt)).attr('stroke','#111').attr('stroke-width',2.8).attr('stroke-linecap','round').attr('fill','none').attr('opacity',0.98);
            });
        }
        function toInitial(){
            clearTimeout(drawTimeoutId);
            layoutInitial(); 
            drawTimeoutId = setTimeout(drawLinksInitial, 80); 
        }
        function toInfra(){ 
            clearTimeout(drawTimeoutId);
            layoutInfra(); 
            drawTimeoutId = setTimeout(drawLinksCatsToDetails, 80); 
        }
        function handleResize(){
            if (infraMapSubState === 1) { 
                layoutInfra(); 
                drawTimeoutId = setTimeout(drawLinksCatsToDetails, 80); 
            } else { 
                layoutInitial(); 
                drawTimeoutId = setTimeout(drawLinksInitial, 80); 
            }
        }
        setTimeout(layoutInitial, 60);
        return { toInitial, toInfra, handleResize };
    })();
    
    /* ==================== 차트/지도 로직 (수정 없음) ==================== */
    // --- 전역 변수 ---
    const CSV_PATH = "./infra_daegi.csv"; 
    let scatterChart, map;
    let scatterData = { '국공립':[], '민간':[] };
    let mapMarkers = [];
    let isMapPopulated = false;

    const originalRadius = 5;
    const highlightRadius = 10;
    const highlightColor = '#22c55e';
    const originalColors = { '국공립': 'rgba(107, 174, 214, 0.8)', '민간': 'rgba(252, 146, 114, 0.8)' };

    // --- 유틸 함수 ---
    const toNum = v => { if (v === null || v === undefined) return NaN; if (typeof v === 'number') return v; const s = String(v).replace(/[%,_\s]/g,'').replace(/\u00A0/g,'').replace(/−/g,'-'); const n = Number(s); return Number.isFinite(n) ? n : NaN; };
    const mean = arr => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : NaN;
    const quantile = (arr, q) => { if(!arr.length) return NaN; const s=[...arr].sort((a,b)=>a-b); const idx = Math.floor(s.length*q); return s[Math.min(idx, s.length-1)]; };

    // --- 데이터 로딩 및 초기화 ---
    fetch(CSV_PATH)
      .then(res => {
        if (!res.ok) throw new Error("CSV 파일을 불러올 수 없습니다. 경로를 확인하세요.");
        return res.text();
      })
      .then(text => {
        const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
        const rows = (parsed.data||[]).filter(r => Object.values(r).some(v => String(v).trim() !== ''));
        if(!rows.length) throw new Error('CSV가 비어 있습니다.');
        
        const cols = Object.keys(rows[0]);
        const labelCol = ['기관명', '어린이집명', '시설명'].find(k=> cols.includes(k)) || cols[0];
        const addressKey = '주소_정제';
        const latitudeKey = ['위도', 'lat', 'latitude'].find(k=> cols.includes(k));
        const longitudeKey = ['경도', 'lon', 'longitude'].find(k=> cols.includes(k));
        const waitKey  = ['총_대기율','대기율'].find(k=> cols.includes(k));
        const infraKey = ['final_score','인프라'].find(k=> cols.includes(k));
        const typeKey  = ['설립유형','유형'].find(k=> cols.includes(k));
        
        if(!waitKey || !infraKey || !latitudeKey || !longitudeKey){ 
            throw new Error('필수 컬럼(총_대기율, final_score, 위도, 경도)을 찾을 수 없습니다.');
        }

        const waitRaw = rows.map(r => toNum(r[waitKey]));
        const infraRaw = rows.map(r => toNum(r[infraKey]));
        const validW = waitRaw.filter(Number.isFinite); const wCut = quantile(validW, 0.99); const wMin = Math.min(...validW); const wMaxC = Math.max(...validW.map(v=> Math.min(v, wCut)));
        const validI = infraRaw.filter(Number.isFinite); const iCut = quantile(validI, 0.99); const iMin = Math.min(...validI); const iMaxC = Math.max(...validI.map(v => Math.min(v, iCut)));
        const waitStd = waitRaw.map(v => Number.isFinite(v) ? ((Math.min(v, wCut) - wMin) / (wMaxC - wMin || 1)) : NaN);
        const infraStd = infraRaw.map(v => Number.isFinite(v) ? ((Math.min(v, iCut) - iMin) / (iMaxC - iMin || 1)) : NaN);
        
        rows.forEach((r, i) => {
          const x = infraStd[i], y = waitStd[i], lat = toNum(r[latitudeKey]), lon = toNum(r[longitudeKey]);
          if(!Number.isFinite(x) || !Number.isFinite(y) || !Number.isFinite(lat) || !Number.isFinite(lon)) return;
          const type = r[typeKey] || '기타';
          const key = (type === '국공립' || type === '민간') ? type : '기타';
          if (key === '기타') return;
          scatterData[key].push({ x, y, lat, lon, name: String(r[labelCol] ?? ''), address: String(r[addressKey] ?? '') });
        });

        const xThr = mean(infraStd.filter(Number.isFinite));
        const yThr = mean(waitStd.filter(Number.isFinite));

        createScatterChart(xThr, yThr);
        initMap();
        setupSearch();

        document.getElementById('status').textContent = `${(scatterData['국공립'].length + scatterData['민간'].length).toLocaleString()}개 어린이집 정보 로드 완료`;
      })
      .catch(err => {
        document.getElementById('status').textContent = '오류: ' + err.message;
        console.error(err);
      });

    // --- 차트 및 지도 생성 함수 ---
    function createScatterChart(xThr, yThr) {
        const datasets = [];
        if(scatterData['국공립'].length) datasets.push({ label: '국공립', data: scatterData['국공립'], backgroundColor: originalColors['국공립'] });
        if(scatterData['민간'].length) datasets.push({ label: '민간', data: scatterData['민간'], backgroundColor: originalColors['민간'] });
        
        const ctx = document.getElementById('scatterChart').getContext('2d');
        scatterChart = new Chart(ctx, { type: 'scatter', data: { datasets }, options: { animation: { duration: 400 }, responsive: true, maintainAspectRatio: false, elements: { point: { radius: originalRadius }}, scales: { x: { title: { display: true, text: '인프라 점수 (0–1)' }, min: -0.05, max: 1.05 }, y: { title: { display: true, text: '대기율 (0–1)' }, min: -0.05, max: 1.05 } }, plugins: { title: { display: false }, tooltip: { callbacks: { title: (tooltipItems) => { return tooltipItems[0].raw.name; }, afterBody: (tooltipItems) => { const item = tooltipItems[0].raw; return [ `주소: ${item.address}`, `인프라: ${item.x.toFixed(2)}`, `대기율: ${item.y.toFixed(2)}` ]; } } }, legend: {}, annotation: { annotations: { lineX: { type: 'line', xMin: xThr, xMax: xThr, borderColor: 'gray', borderWidth: 1.5, borderDash: [6, 6], label: { content: `인프라 평균 (${xThr.toFixed(2)})`, enabled: true, position: 'start', backgroundColor: 'rgba(245, 245, 245, 0.7)' } }, lineY: { type: 'line', yMin: yThr, yMax: yThr, borderColor: 'gray', borderWidth: 1.5, borderDash: [6, 6], label: { content: `대기율 평균 (${yThr.toFixed(2)})`, enabled: true, position: 'start', backgroundColor: 'rgba(245, 245, 245, 0.7)' } } } } } } });
    }

    function initMap() {
        if (map) return;
        map = L.map('map').setView([37.5665, 126.9780], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19 }).addTo(map);

        fetch('https://raw.githubusercontent.com/southkorea/seoul-maps/master/kostat/2013/json/seoul_municipalities_geo_simple.json')
            .then(res => res.json())
            .then(geojson => {
                const geojsonLayer = L.geoJson(geojson, { style: { color: "#007bff", weight: 1.5, opacity: 0.7, fillOpacity: 0.05 }, onEachFeature: (feature, layer) => { layer.bindTooltip(feature.properties.SIG_KOR_NM, { permanent: false, direction: 'center' }); } }).addTo(map);
                map.fitBounds(geojsonLayer.getBounds().pad(0.1));
                map.setMaxBounds(geojsonLayer.getBounds().pad(0.5));
                map.setMinZoom(10);
            });
    }

    function populateMap(query = "") {
        if (isMapPopulated || !map) return;
        isMapPopulated = true;
        
        setTimeout(() => map.invalidateSize(), 10); 

        const allPoints = [...scatterData['국공립'], ...scatterData['민간']];
        allPoints.forEach((point, index) => {
            setTimeout(() => {
                if (!isMapPopulated) return;

                const nameWithoutSuffix = point.name.replace(/어린이집$/, '').trim().toLowerCase();
                const isHighlighted = query && nameWithoutSuffix.includes(query);
                
                const type = scatterData['국공립'].includes(point) ? '국공립' : '민간';
                const color = isHighlighted ? highlightColor : originalColors[type];
                const radius = isHighlighted ? highlightRadius : originalRadius;

                const icon = L.divIcon({
                    html: `<div style="background-color:${color}; width:${radius*2}px; height:${radius*2}px; border-radius:50%;"></div>`,
                    className: 'map-marker', iconSize: [radius*2, radius*2], iconAnchor: [radius, radius]
                });

                const marker = L.marker([point.lat, point.lon], { icon, title: point.name }).addTo(map);
                marker.bindPopup(`<b>${point.name}</b><br>${point.address}<hr style="margin:4px 0;">인프라: ${point.x.toFixed(2)} | 대기율: ${point.y.toFixed(2)}`);
                mapMarkers.push({ marker, pointData: point });
            }, index * 1);
        });
    }

    function clearMap() {
        if (!isMapPopulated) return;
        isMapPopulated = false;
        mapMarkers.forEach(item => item.marker.remove());
        mapMarkers = [];
    }

    function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');

        const performSearch = () => {
            const query = searchInput.value.trim().toLowerCase();
            
            scatterChart.data.datasets.forEach(dataset => {
                const datasetLabel = dataset.label;
                const originalData = scatterData[datasetLabel];
                const backgroundColors = [];
                const pointRadii = [];

                originalData.forEach(point => {
                    const nameWithoutSuffix = point.name.replace(/어린이집$/, '').trim().toLowerCase();
                    if (query && nameWithoutSuffix.includes(query)) {
                        backgroundColors.push(highlightColor);
                        pointRadii.push(highlightRadius);
                    } else {
                        backgroundColors.push(originalColors[datasetLabel]);
                        pointRadii.push(originalRadius);
                    }
                });
                dataset.backgroundColor = backgroundColors;
                dataset.pointRadius = pointRadii;
            });
            scatterChart.update();

            if (isMapPopulated) {
                mapMarkers.forEach(item => item.marker.remove());
                mapMarkers = [];
                isMapPopulated = false;
                populateMap(query);
            }
        };

        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') performSearch(); });
    }
    
    // --- 5. 초기화 (기존) ---
    setEquationState(0); autoFitEquation();
    window.addEventListener('resize', ()=>{
        autoFitEquation();
        infraMapLogic.handleResize();
    });
    renderState(0);
  </script>
</body>

</html>


